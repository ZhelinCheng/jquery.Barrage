!function(t){"use strict";!function(){for(var t=0,a=["webkit","moz"],i=0;i<a.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[a[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[i]+"CancelAnimationFrame"]||window[a[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,i){var e=(new Date).getTime(),r=Math.max(0,16-(e-t)),n=window.setTimeout(function(){a(e+r)},r);return t=e+r,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var a=function(a,i){return a?(this.box=t(a),this.speed=i.speed||1,this.direction=i.direction||"left",this.row=i.row||2,this.number=i.number||4,this.margin=i.margin||0,this.hoverStop=i.hoverStop||!1,this.dataUrl=i.dataUrl,this.dataBox=i.dataBox,this.dataBase=[],this.dataBaseLen=0,this.dataStart=this.number,this.dataAllLen=0,this.dataAllStart=1,this.firstOffset=[],this.firstWidth=[],this.compatible="transform",this.structure=i.structure,void this.init()):void console.error("未指定盒子！")};a.prototype={init:function(){navigator.appVersion.indexOf("MSIE 9.0")>0&&("left"==this.direction||"right"==this.direction?this.compatible="margin-left":this.compatible="margin-top"),this.box.css("overflow","hidden"),this.getData(this.dataAllStart,this.rendering)},getData:function(a,i){var e=this;if(this.dataUrl)t.ajax({url:e.dataUrl,type:"get",dataType:"jsonp",data:{page:a||1,page_size:this.number+10},success:function(t){var r=t.code;0==r?(e.dataBase=e.dataBase.concat(t.result.list),e.dataSatisfy(),e.dataAllLen=t.result.page_total,e.dataAllStart=++a,"function"==typeof i&&i(e.dataBase,e)):console.error(r)},error:function(){alert("网络错误，请刷新或稍后重试！")}});else{if(!this.dataBox)return console.error("未添加数据源！"),!1;Array.prototype.push.apply(this.dataBase,t(this.dataBox).children()),e.dataSatisfy(),"function"==typeof i&&i(e.dataBase,e)}},dataSatisfy:function(){var t=this.dataBase.length;t<this.number?(this.dataBase=this.dataBase.concat(this.dataBase),this.dataSatisfy()):this.dataBaseLen=t},getItem:function(t,a){var i="";return i=this.dataUrl?this.structure(t,a):t.outerHTML},rendering:function(t,a){function i(){if("object"==typeof a.margin)for(n+='<ul class="barrage-row row-'+s+'"></ul>',a.box.html(n),o=0;o<a.number;o++)n=a.getItem(t[o],o),a.box.find(".barrage-row").append(n).children("li:last").css("margin-bottom",a.getRandom()+"px");else{for(n+='<ul class="barrage-row row-'+s+'">',o=0;o<a.number;o++)n+=a.getItem(t[o],o);n+="</ul>",a.box.html(n)}var i=a.box.children("ul");for(s=0;s<a.row;s++){a.firstOffset[s]=0;var e=0,r=null;r=i.eq(s),e=r.children("li").eq(0).height()+a.getMargin(r,a.direction),a.firstWidth[s]=e}!function h(){a.posMove(i,a.speed),requestAnimationFrame(h)}()}function e(){if("object"==typeof a.margin){for(s=0;s<a.row;s++)n+='<ul class="barrage-row row-'+s+'"></ul>';for(a.box.html(n),o=0;o<a.number;o++)r=o%a.row,n=a.getItem(t[o],o),a.box.find(".row-"+r).append(n).children("li:last").css("margin-right",a.getRandom()+"px")}else{for(s=0;s<a.row;s++){for(n+='<ul class="barrage-row row-'+s+'">',o=0;o<a.number;o++)h=t[o],r=o%a.row,s==r&&(n+=a.getItem(h,o));n+="</ul>"}a.box.html(n)}var i=a.box.children("ul");for(s=0;s<a.row;s++){a.firstOffset[s]=0;var e=0,h=null;h=i.eq(s),e=h.children("li").eq(0).width()+a.getMargin(h,a.direction),a.firstWidth[s]=e}!function l(){a.posMove(i,a.speed),requestAnimationFrame(l)}()}var r=0,n="",s=0,o=0;"left"==a.direction||"right"==a.direction?e():(i(),a.row=1),1==a.hoverStop&&a.hoverStopFn()},posMove:function(t,a){function i(t,a){a="left"==h||"right"==h?"translateX("+a+"px)":"translateY("+a+"px)",t.css(n.compatible,a)}function e(t,a){a+="px",t.css(n.compatible,a)}for(var r=this.row,n=this,s=this.firstOffset,o=this.firstWidth,h=this.direction,l=null,d=0;d<r;d++)l=t.eq(d),s[d]>=o[d]&&(l.children("li:first-child").remove(),"left"==h||"right"==h?(s[d]=s[d]-o[d],o[d]=this.getMargin(l,h)+l.children("li:first-child").width()):(s[d]=s[d]-o[d]-1,o[d]=this.getMargin(l,h)+l.children("li:first-child").height()),this.addData(l)),l.hasClass("stop")||"transform"!=this.compatible?l.hasClass("stop")||"transform"==this.compatible||e(l,-(s[d]+=a)):i(l,-(s[d]+=a))},hoverStopFn:function(){this.box.on("mouseover","li",function(){t(this).parent().addClass("stop")}),this.box.on("mouseout","li",function(){t(this).parent().removeClass("stop")})},addData:function(t){this.dataStart>=this.dataBaseLen&&(this.dataAllStart<=this.dataAllLen&&this.getData(this.dataAllStart),this.dataStart=0),t.append(this.getItem(this.dataBase[this.dataStart],this.dataStart)),t.children("li:last").css("margin-right",this.getRandom()+"px"),this.dataStart++},getRandom:function(){if("object"==typeof this.margin)return Math.floor(this.margin[0]+Math.random()*(this.margin[1]-this.margin[0]))},getMargin:function(t,a){var i=t.children().eq(0),e=null;return e="left"==a||"right"==a?parseInt(i.css("margin-right"))+parseInt(i.css("margin-left")):parseInt(i.css("margin-top"))+parseInt(i.css("margin-bottom"))}},window.Barrage=a,t.fn.Barrage=function(t,i){new a(t,i)}}(jQuery);